"use strict";(()=>{var A="app-v1";var Q=e=>`${x(e)}/offline.html`,N={key:"X-Cache-Hit",value:"SW HIT"},X="Sw-Net-Err",z="Sw-Policy",q=1,M=2,Y=3,K=4,Z={networkOnly:{"Sw-Policy":M.toString()},networkFirst:{"Sw-Policy":q.toString()},cacheFirst:{"Sw-Policy":Y.toString()},cacheOnly:{"Sw-Policy":K.toString()}},P=(e,n)=>({"Last-Modified":new Date().toUTCString(),"Sw-Source":"shabah","Content-Length":n.toString(),"Content-Type":e}),x=e=>e.endsWith("/")?e.slice(0,-1):e,ee=e=>`${x(e)}/__download-indices__.json`,te=e=>`${x(e)}/__cargo-indices__.json`,y={updatedExisting:0,createdNew:1,notFound:2,removed:3,saved:4},Ce=e=>`${x(e)}/__err-download-index__.json`,ke=e=>!e.startsWith("http://")&&!e.startsWith("https://");var oe=async(e,n,t)=>{if(ke(e))throw new Error("error download indices storage url must be a full url and not a relative one. Got "+e);let o=Ce(e),s=JSON.stringify(n),p=new Response(s,{status:200,statusText:"OK"});return await t.putFile(o,p),y.saved},J=()=>({downloads:[],totalBytes:0,version:1,updatedAt:Date.now(),createdAt:Date.now(),savedAt:Date.now()}),ne=async(e,n)=>{let t=ee(e),o=await n.getFile(t);if(!o||!o.ok)return J();try{return await o.json()}catch{return J()}};var re=(e,n)=>{let t=e.downloads.findIndex(s=>s.id===n);if(t<0)return y.notFound;let o=e.downloads[t];return e.totalBytes-=o.bytes,e.downloads.splice(t,1),y.removed},se=async(e,n,t)=>{e.savedAt=Date.now();let o=JSON.stringify(e),s=ee(n);return await t.putFile(s,new Response(o,{status:200,statusText:"OK",headers:P("application/json",ce(o))})),y.saved},V=()=>({cargos:[],updatedAt:Date.now(),createdAt:Date.now(),savedAt:Date.now(),version:1}),ae=async(e,n)=>{let t=te(e),o=await n.getFile(t);if(!o||!o.ok)return V();try{return await o.json()}catch{return V()}},ie=(e,n)=>{let t=Date.now();e.updatedAt=t;let o=e.cargos.findIndex(c=>c.id===n.id);if(o<0)return e.cargos.push({...n,updatedAt:t,createdAt:t}),y.createdNew;let p={...e.cargos[o],...n,updatedAt:t};return e.cargos[o]=p,y.updatedExisting},ce=e=>new TextEncoder().encode(e).length,le=async(e,n,t)=>{e.savedAt=Date.now();let o=JSON.stringify(e),s=te(n);return await t.putFile(s,new Response(o,{status:200,statusText:"OK",headers:P("application/json",ce(o))})),y.saved};var R=e=>{let{fileCache:n,origin:t,log:o,type:s}=e;return async p=>{let c=`[\u{1F415}\u200D\u{1F9BA} bg-fetch ${s}]`,w=p.registration;o(c,"registration:",w);let a=w.id,f=await w.matchAll();if(o(c,"resources downloaded",f.map(d=>d.request.url)),f.length<0)return;let[I,C]=await Promise.all([ne(t,n),ae(t,n)]),k=I.downloads.findIndex(({id:d})=>d===a),_=C.cargos.findIndex(d=>d.id===a);if(o(c,`found: cargo=${_>-1}, download=${k>-1}`),k<0||_<0)return;let r=I.downloads[k],{map:l,title:$,id:ye}=r,F=f.length;o(c,"processing download for pkg",ye);let W=30,U=0,T=Math.min(F,W),H=0,j=0,B={...r,map:{},bytes:0,startedAt:Date.now()};for(;U<F;){let d=[];for(let u=U;u<T;u++){let D=f[u];d.push((async()=>{let m=await D.responseReady,h=(v=>{if(v.startsWith("https://")||v.startsWith("http://"))return v;let Ie=v.startsWith("/")?v:"/"+v;return`${x(t)}/${Ie}`})(D.request.url),L=l[h];if(!L)return o(c,`orphaned resource found url=${h}, couldn't map to resource`);H++;let{storageUrl:xe,bytes:G,mime:me}=L;if(!m.ok){B.map[h]={...L,status:m.status,statusText:m.statusText||"UNKNOWN STATUS"},j++,B.bytes+=G;return}let ve=await m.text();return n.putFile(xe,new Response(ve,{status:200,statusText:"OK",headers:P(me,G)}))})())}await Promise.all(d),U+=W,T=Math.min(F,T+W)}if(o(c,`processed ${H} out of ${F}. orphan_count=${F-H}, fail_count=${j}`),re(I,a),ie(C,{...C.cargos[_],state:(d=>{switch(d){case"abort":return"update-aborted";case"fail":return"update-failed";case"success":default:return"cached"}})(s)}),await Promise.all([le(C,t,n),se(I,t,n)]),s==="abort"||s==="fail"){let{storageRootUrl:d}=r,u=d;if(!u.startsWith("https://")&&!u.startsWith("http://")){let D=x(t),m=(h=>h.startsWith("./")?h.slice(2):h.startsWith("/")?h.slice(1):h)(u);u=`${D}/${m}`,o(c,`detected storage root url as a relative url - full url is required. Adding origin to url original=${d}, new=${u}`)}await oe(u,B,n),o(c,"successfully saved error log")}if(o(c,"successfully persisted changes"),(s==="fail"||s==="success")&&p.updateUI){let d=s==="fail"?"failed":"finished";await p.updateUI({title:`${$} ${d}!`})}}};var b=N.key,E=N.value,Fe=Z.cacheFirst["Sw-Policy"],de=e=>new Response("",{status:500,statusText:"Internal Server Error",headers:{[X]:String(e)||"1"}}),ue=new Response("not in cache",{status:404,statusText:"NOT FOUND"}),ge=e=>{let{origin:n,fileCache:t,fetchFile:o,log:s}=e,p=n.endsWith("/")?n:n+"/",c=Q(n);return async w=>{let{request:a}=w,f=a.url.split("?")[0];if(f===p)try{let r=await o(a);return s(`requesting root document (network-first): url=${a.url}, status=${r.status}`),r}catch(r){let l=await t.getFile(c);return s(`root doc request failed: fallback_url=${c}, network_err=true, status=${l?.status||"none"}, status_text=${l?.statusText||"none"}`),l&&l.ok?(l.headers.append(b,E),l):de(r)}if(f===c){let r=await t.getFile(c);return s(`requesting root document fallback (cache-only): url=${a.url}, exists=${!!r}, status=${r?.status||"none"}`),r&&r.ok?(r.headers.append(b,E),r):ue}let k=a.headers.get(z)||Fe;switch(parseInt(k,10)){case q:try{let r=await o(a);return s(`incoming request (network-first): url=${a.url}, status=${r.status}`),r}catch(r){let l=await t.getFile(a.url),$=l&&l.ok;return s(`incoming request (network-first): url=${a.url}, network_err=true, cache_fallback=${$}`),l&&l.ok?(l.headers.append(b,E),l):de(r)}case M:return s(`incoming request (network-only): url=${w.request.url}`),o(a);case K:{let r=await t.getFile(a.url);return s(`incoming request (cache-only): url=${a.url}, found=${!!r}, status=${r?.status||"none"}`),r&&r.ok?(r.headers.append(b,E),r):ue}case Y:default:{let r=await t.getFile(a.url);return s(`incoming request (cache-first): url=${a.url}, cache_hit=${!!r}, status=${r?.status||"none"}`),r&&r.ok?(r.headers.append(b,E),r):o(w.request)}}}};var pe=e=>({getFile:async t=>await(await caches.open(e)).match(t)||null,putFile:async(t,o)=>(await(await caches.open(e)).put(t,o),!0),deleteFile:async t=>(await caches.open(e)).delete(t),listFiles:async()=>await(await caches.open(e)).keys(),deleteAllFiles:async()=>await caches.delete(e),queryUsage:async()=>{let{quota:t=0,usage:o=0}=await navigator.storage.estimate();return{quota:t,usage:o}},isPersisted:async()=>await navigator.storage.persisted(),requestPersistence:async()=>await navigator.storage.persist()});var i=globalThis.self,we=`${i.location.origin}/__sw-config__.json`,g={version:1,log:!0,updatedAt:-1,createdAt:Date.now()};caches.open(A).then(async e=>{let n=await e.match(we);if(!n)return fe();let t=await n.json();g={...g,...t}});var fe=async()=>{let e=await caches.open(A);return g.updatedAt=Date.now(),e.put(we,new Response(JSON.stringify(g),{status:200}))};i.oninstall=e=>e.waitUntil(i.skipWaiting());i.onactivate=e=>{e.waitUntil((async()=>{await i.clients.claim(),console.info("[\u{1F4E5} install] new service-worker installed"),console.info("[\u{1F525} activate] new sevice worker in control, started with config",g)})())};var S=pe(A),O=(...e)=>{g.log&&console.info(...e)},be=ge({fileCache:S,origin:i.location.origin,fetchFile:fetch,log:O});i.onfetch=e=>e.respondWith(be(e));var Ee=R({origin:i.location.origin,fileCache:S,log:O,type:"success"});i.onbackgroundfetchsuccess=e=>e.waitUntil(Ee(e));i.onbackgroundfetchclick=()=>i.clients.openWindow("/");var _e=R({origin:i.location.origin,fileCache:S,log:O,type:"abort"});i.onbackgroundfetchabort=e=>e.waitUntil(_e(e));var De=R({origin:i.location.origin,fileCache:S,log:O,type:"fail"});i.onbackgroundfetchfail=e=>e.waitUntil(De(e));var he={"config:silent_logs":()=>{g.log=!1},"config:verbose_logs":()=>{g.log=!0},"list:connected_clients":async e=>{let n=await i.clients.matchAll();console.info(`connected clients (${n.length}): ${n.map(t=>`(id=${t.id||"unknown"}, url=${t.url}, type=${t.type})
`).join(",")}`)},"list:config":e=>{console.info("config:",g)}};i.onmessage=e=>e.waitUntil((async()=>{let n=e.data,t=e.source.id;if(!he[n?.action])return console.warn(`received incorrectly encoded message ${n} from client ${t}`);await he[n.action](t),n.action.startsWith("config:")&&(fe(),console.info("config changed, new config:",g))})());})();
