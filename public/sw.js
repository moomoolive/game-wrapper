"use strict";(()=>{var R="app-v1";var Q=e=>`${x(e)}/offline.html`,L={key:"X-Cache-Hit",value:"SW HIT"},X="Sw-Net-Err",z="Sw-Policy",M=1,B=2,Y=3,j=4,Z={networkOnly:{"Sw-Policy":B.toString()},networkFirst:{"Sw-Policy":M.toString()},cacheFirst:{"Sw-Policy":Y.toString()},cacheOnly:{"Sw-Policy":j.toString()}},A=(e,n)=>({"Last-Modified":new Date().toUTCString(),"Sw-Source":"shabah","Content-Length":n.toString(),"Content-Type":e}),x=e=>e.endsWith("/")?e.slice(0,-1):e,ee=e=>`${x(e)}/__download-indices__.json`,te=e=>`${x(e)}/__cargo-indices__.json`,y={updatedExisting:0,createdNew:1,notFound:2,removed:3,saved:4},Ie=e=>`${x(e)}/__err-download-index__.json`,Fe=e=>!e.startsWith("http://")&&!e.startsWith("https://");var oe=async(e,n,t)=>{if(Fe(e))throw new Error("error download indices storage url must be a full url and not a relative one. Got "+e);let o=Ie(e),r=JSON.stringify(n),u=new Response(r,{status:200,statusText:"OK"});return await t.putFile(o,u),y.saved},G=()=>({downloads:[],totalBytes:0,version:1,updatedAt:Date.now(),createdAt:Date.now(),savedAt:Date.now()}),ne=async(e,n)=>{let t=ee(e),o=await n.getFile(t);if(!o||!o.ok)return G();try{return await o.json()}catch{return G()}};var se=(e,n)=>{let t=e.downloads.findIndex(r=>r.id===n);if(t<0)return y.notFound;let o=e.downloads[t];return e.totalBytes-=o.bytes,e.downloads.splice(t,1),y.removed},re=async(e,n,t)=>{e.savedAt=Date.now();let o=JSON.stringify(e),r=ee(n);return await t.putFile(r,new Response(o,{status:200,statusText:"OK",headers:A("application/json",ce(o))})),y.saved},V=()=>({cargos:[],updatedAt:Date.now(),createdAt:Date.now(),savedAt:Date.now(),version:1}),ae=async(e,n)=>{let t=te(e),o=await n.getFile(t);if(!o||!o.ok)return V();try{return await o.json()}catch{return V()}},ie=(e,n)=>{let t=Date.now();e.updatedAt=t;let o=e.cargos.findIndex(c=>c.id===n.id);if(o<0)return e.cargos.push({...n,updatedAt:t,createdAt:t}),y.createdNew;let u={...e.cargos[o],...n,updatedAt:t};return e.cargos[o]=u,y.updatedExisting},ce=e=>new TextEncoder().encode(e).length,le=async(e,n,t)=>{e.savedAt=Date.now();let o=JSON.stringify(e),r=te(n);return await t.putFile(r,new Response(o,{status:200,statusText:"OK",headers:A("application/json",ce(o))})),y.saved};var S=e=>{let{fileCache:n,origin:t,log:o,type:r}=e;return async u=>{let c=`[\u{1F415}\u200D\u{1F9BA} bg-fetch ${r}]`,w=u.registration;o(c,"registration:",w);let a=w.id,f=await w.matchAll();if(o(c,"resources downloaded",f.map(d=>d.request.url)),f.length<0)return;let[I,F]=await Promise.all([ne(t,n),ae(t,n)]),b=I.downloads.findIndex(({id:d})=>d===a),D=F.cargos.findIndex(d=>d.id===a);if(o(c,`found: cargo=${D>-1}, download=${b>-1}`),b<0||D<0)return;let s=I.downloads[b],{map:l,title:E,id:fe}=s,k=f.length;o(c,"processing download for pkg",fe);let T=30,H=0,W=Math.min(k,T),U=0,K=0,q={...s,map:{},bytes:0,startedAt:Date.now()};for(;H<k;){let d=[];for(let p=H;p<W;p++){let P=f[p];d.push((async()=>{let m=await P.responseReady,h=(C=>{if(C.startsWith("https://")||C.startsWith("http://"))return C;let Ce=C.startsWith("/")?C:"/"+C;return`${x(t)}/${Ce}`})(P.request.url),N=l[h];if(!N)return o(c,`orphaned resource found url=${h}, couldn't map to resource`);U++;let{storageUrl:ye,bytes:J,mime:xe}=N;if(!m.ok){q.map[h]={...N,status:m.status,statusText:m.statusText||"UNKNOWN STATUS"},K++,q.bytes+=J;return}let me=await m.text();return n.putFile(ye,new Response(me,{status:200,statusText:"OK",headers:A(xe,J)}))})())}await Promise.all(d),H+=T,W=Math.min(k,W+T)}if(o(c,`processed ${U} out of ${k}. orphan_count=${k-U}, fail_count=${K}`),se(I,a),ie(F,{...F.cargos[D],state:(d=>{switch(d){case"abort":return"update-aborted";case"fail":return"update-failed";case"success":default:return"cached"}})(r)}),await Promise.all([le(F,t,n),re(I,t,n)]),r==="abort"||r==="fail"){let{storageRootUrl:d}=s,p=d;if(!p.startsWith("https://")&&!p.startsWith("http://")){let P=x(t),m=(h=>h.startsWith("./")?h.slice(2):h.startsWith("/")?h.slice(1):h)(p);p=`${P}/${m}`,o(c,`detected storage root url as a relative url - full url is required. Adding origin to url original=${d}, new=${p}`)}await oe(p,q,n),o(c,"successfully saved error log")}if(o(c,"successfully persisted changes"),(r==="fail"||r==="success")&&u.updateUI){let d=r==="fail"?"failed":"finished";await u.updateUI({title:`${E} ${d}!`})}}};var v=L.key,_=L.value,be=Z.cacheFirst["Sw-Policy"],de=e=>new Response("",{status:500,statusText:"Internal Server Error",headers:{[X]:String(e)||"1"}}),ue=new Response("not in cache",{status:404,statusText:"NOT FOUND"}),pe=e=>{let{origin:n,fileCache:t,fetchFile:o,log:r}=e,u=n.endsWith("/")?n:n+"/",c=Q(n);return async w=>{let{request:a}=w;r(`incoming request (mode=${a.mode}) from: ${a.referrer}`);let f=a.url.split("?")[0];if(f===u)try{let s=await o(a);return r(`requesting root document (network-first): url=${a.url}, status=${s.status}`),s}catch(s){let l=await t.getFile(c);return r(`root doc request failed: fallback_url=${c}, network_err=true, status=${l?.status||"none"}, status_text=${l?.statusText||"none"}`),l&&l.ok?(l.headers.append(v,_),l):de(s)}if(f===c){let s=await t.getFile(c);return r(`requesting root document fallback (cache-only): url=${a.url}, exists=${!!s}, status=${s?.status||"none"}`),s&&s.ok?(s.headers.append(v,_),s):ue}let b=a.headers.get(z)||be;switch(parseInt(b,10)){case M:try{let s=await o(a);return r(`incoming request (network-first): url=${a.url}, status=${s.status}`),s}catch(s){let l=await t.getFile(a.url),E=l&&l.ok;return r(`incoming request (network-first): url=${a.url}, network_err=true, cache_fallback=${E}`),l&&l.ok?(l.headers.append(v,_),l):de(s)}case B:return r(`incoming request (network-only): url=${w.request.url}`),o(a);case j:{let s=await t.getFile(a.url);return r(`incoming request (cache-only): url=${a.url}, found=${!!s}, status=${s?.status||"none"}`),s&&s.ok?(s.headers.append(v,_),s):ue}case Y:default:{let s=await t.getFile(a.url);return r(`incoming request (cache-first): url=${a.url}, cache_hit=${!!s}, status=${s?.status||"none"}`),s&&s.ok?(s.headers.append(v,_),s):o(w.request)}}}};var ge=e=>({getFile:async t=>await(await caches.open(e)).match(t)||null,putFile:async(t,o)=>(await(await caches.open(e)).put(t,o),!0),deleteFile:async t=>(await caches.open(e)).delete(t),listFiles:async()=>await(await caches.open(e)).keys(),deleteAllFiles:async()=>await caches.delete(e),queryUsage:async()=>{let{quota:t=0,usage:o=0}=await navigator.storage.estimate();return{quota:t,usage:o}},isPersisted:async()=>await navigator.storage.persisted(),requestPersistence:async()=>await navigator.storage.persist()});var i=globalThis.self,he=`${i.location.origin}/__sw-config__.json`,g={version:1,log:!0,updatedAt:-1,createdAt:Date.now()};caches.open(R).then(async e=>{let n=await e.match(he);if(!n)return we();let t=await n.json();g={...g,...t}});var we=async()=>{let e=await caches.open(R);return g.updatedAt=Date.now(),e.put(he,new Response(JSON.stringify(g),{status:200}))};i.oninstall=e=>e.waitUntil(i.skipWaiting());i.onactivate=e=>{e.waitUntil((async()=>{await i.clients.claim(),console.info("[\u{1F4E5} install] new service-worker installed"),console.info("[\u{1F525} activate] new sevice worker in control, started with config",g)})())};var O=ge(R),$=(...e)=>{g.log&&console.info(...e)},ke=pe({fileCache:O,origin:i.location.origin,fetchFile:fetch,log:$});i.onfetch=e=>e.respondWith(ke(e));var ve=S({origin:i.location.origin,fileCache:O,log:$,type:"success"});i.onbackgroundfetchsuccess=e=>e.waitUntil(ve(e));i.onbackgroundfetchclick=()=>i.clients.openWindow("/");var _e=S({origin:i.location.origin,fileCache:O,log:$,type:"abort"});i.onbackgroundfetchabort=e=>e.waitUntil(_e(e));var De=S({origin:i.location.origin,fileCache:O,log:$,type:"fail"});i.onbackgroundfetchfail=e=>e.waitUntil(De(e));var Pe=e=>{throw new Error("code path should never branch to here")};i.onmessage=e=>e.waitUntil((async()=>{let n=e.data;if(typeof n.action!="string")return;let{action:t}=n;switch(t){case"config:verbose_logs":g.log=!0;break;case"config:silent_logs":g.log=!1;break;case"list:connected_clients":{let r=(await i.clients.matchAll()).map(u=>`(id=${u.id||"unknown"}, url=${u.url}, type=${u.type})
`);console.info(`connected clients: ${r.join(",")}`);break}case"list:config":console.info("config:",g);break;default:return Pe(t)}n.action.startsWith("config:")&&(we(),console.info("config changed, new config:",g))})());})();
